!function(N,P,x){"use strict";var F="ht",M=N[F],d=M.Default,T=d.def,z=d.getInternal();M.HistoryManager=function(L){this._histories=[],this.setDataModel(L)},T(M.HistoryManager,P,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var z=this;z._betweenTransaction++,1===z._betweenTransaction&&(z._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var v=this,r=v._histories;v._betweenTransaction>0&&v._betweenTransaction--,0===v._betweenTransaction&&(v._transactionHistories&&v._transactionHistories.length&&(r=r.slice(0,v._historyIndex+1),r.push(v._transactionHistories),r.length>v._maxHistoryCount&&(r=r.slice(r.length-v._maxHistoryCount)),v.setHistories(r),v.setHistoryIndex(r.length-1,!0)),delete v._transactionHistories)}},setDataModel:function(G){var E=this,S=E._dataModel;S!==G&&(S&&(delete S._historyManager,S.ump(E.handleDataModelPropertyChange,E),S.umm(E.$5p,E),S.umd(E.$6p,E),S.removeHierarchyChangeListener(E.handleHierarchyChange,E),S.removeIndexChangeListener(E.handleIndexChange,E)),E._dataModel=G,G&&(G._historyManager=E,G.mp(E.handleDataModelPropertyChange,E),G.mm(E.$5p,E),G.md(E.$6p,E),G.addHierarchyChangeListener(E.handleHierarchyChange,E),G.addIndexChangeListener(E.handleIndexChange,E)),E.fp("dataModel",S,G),E.clear())},setHistoryIndex:function(N,e){var c=this,d=c._historyIndex,g=c._histories.length;if(-1>N?N=-1:N>=g&&(N=g-1),d!==N){if(!e){var C=N-d;C>0?c.$2p(C):0>C&&c.$1p(-C)}c._historyIndex=N,c.fp("historyIndex",d,N),c.dataModel&&c.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(k){var P=this,R=P._histories,p=P._maxHistoryCount;(!k||0>=k)&&(k=10),p!==k&&(P._maxHistoryCount=k,P.fp("maxHistoryCount",p,k),R.length>k&&P.clear())},cloneValue:function(G){return M.Default.clone(G)},isPropertyUndoable:function(R){return R&&!this.ignoredPropertyMap[R]},isDataModelPropertyUndoable:function(Y){return Y&&!this.ignoreDataModelPropertyMap[Y]},$5p:function(a){this.handleChange(a,a.kind)},$6p:function(y){this.handleChange(y,"property")},handleHierarchyChange:function(j){this.handleChange(j,"hierarchy")},handleIndexChange:function(z){this.handleChange(z,"index")},handleDataModelPropertyChange:function(e){this.handleChange(e,"dataModelProperty")},toChildrenInfo:function(D){var C={};return C.data=D,C.children=[],D.eachChild(function(y){C.children.push(this.toChildrenInfo(y))},this),C},restoreChildren:function(F){var R=F.data;F.children.forEach(function(U){var M=U.data;M.getParent()!==R&&R.addChild(M),this._dataModel.contains(M)||this._dataModel.add(M),this.restoreChildren(U)},this)},handleChange:function(k,y){var z=this;if(!(z._disabled||z._isUndoRedoing||d.loadingRefGraph)){var F,X=(z._histories,k.data),O=k.property;if(!X||!(X._refGraph||X instanceof M.RefGraph)){if("property"===y)z.isPropertyUndoable(O,X)&&(F={kind:y,data:X,property:O,oldValue:z.cloneValue(k.oldValue,X,O),newValue:z.cloneValue(k.newValue,X,O),event:k});else if("hierarchy"===y||"index"===y)F={kind:y,data:X,oldIndex:k.oldIndex,newIndex:k.newIndex,event:k};else if("clear"===y)F={kind:y,json:k.json,event:k};else if("add"===y){if(F={kind:y,data:X,event:k,childrenInfo:this.toChildrenInfo(X),parent:X.getParent()},F.parent){var i=z._dataModel.getSiblings(X);F.siblingsIndex=i.indexOf(X)}X instanceof M.Node&&(F.host=X.getHost(),F.attaches=X.getAttaches()?X.getAttaches().toArray():x),X instanceof M.Edge&&(F.source=X.getSource(),F.target=X.getTarget())}else"remove"===y?F={kind:y,data:X,event:k}:"dataModelProperty"===y&&z.isDataModelPropertyUndoable(O,X)&&(F={kind:y,property:O,oldValue:z.cloneValue(k.oldValue,X,O),newValue:z.cloneValue(k.newValue,X,O),event:k});z.addHistory(F)}}},addHistory:function(O){var H=this;if(O)if(H._betweenTransaction){var W=!1;if("property"===O.kind||"dataModelProperty"===O.kind)for(var D=H._transactionHistories.length-1;D>=0;D--){var P=H._transactionHistories[D];if(O.kind===P.kind&&O.property===P.property&&O.data===P.data){O.oldValue=P.oldValue,H._transactionHistories[D]=O,W=!0;break}}W||H._transactionHistories.push(O)}else{var v=H._histories;v=v.slice(0,H._historyIndex+1),v.push([O]),v.length>H._maxHistoryCount&&(v=v.slice(v.length-H._maxHistoryCount)),H.setHistories(v),H.setHistoryIndex(v.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(r){(!r||0>=r)&&(r=1),this.setHistoryIndex(this._historyIndex-r)},$1p:function(s){if(this.canUndo()){var Z,y=this,u=y._dataModel,D=y._histories,b=y._historyIndex,U=0;for(y._isUndoRedoing=!0,d.setIsolating(!0);s>0;){if(b>=0&&b<D.length){U++,Z=D[b],b--;for(var K=Z.length-1;K>=0;K--){var n=Z[K],J=n.kind,Q=n.data,c=n.property,B=n.event,k=this.cloneValue(n.oldValue,Q,c);if(n.undo)n.undo();else if("add"===J)u.remove(Q,{keepChildren:!0});else if("remove"===J)u.contains(Q)||u.add(Q,B.rootsIndex,B.datasIndex);else if("clear"===J)u.deserialize(d.clone(n.json));else if("property"===J)if("parent"===c)k?k.addChild(Q,B.oldIndex):(Q.setParent(k),B.oldIndex>=0&&u.moveTo(Q,B.oldIndex));else{var l=null;0===c.indexOf("a:")?(l="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(l="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(l="field",c=c.replace("f:","")),z.setPropertyValue(Q,l,c,k)}else if("dataModelProperty"===J){var l=null;0===c.indexOf("a:")?(l="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(l="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(l="field",c=c.replace("f:","")),z.setPropertyValue(u,l,c,k)}else"hierarchy"===J?u.moveTo(Q,n.oldIndex):"index"===J&&u.moveToIndex(Q,n.oldIndex)}}s--}d.setIsolating(!1),delete y._isUndoRedoing,y.afterUndo(U)}},afterUndo:function(){},redo:function(q){(!q||0>=q)&&(q=1),this.setHistoryIndex(this._historyIndex+q)},$2p:function(m){if(this.canRedo()){var g,Z=this,u=Z._dataModel,S=Z._histories,c=Z._historyIndex,L=0;for(Z._isUndoRedoing=!0,d.setIsolating(!0);m>0;){if(c>=-1&&c<S.length-1){L++,c++,g=S[c];for(var J=0;J<g.length;J++){var s=g[J],h=s.kind,W=s.data,K=s.property,t=s.event,R=this.cloneValue(s.newValue,W,K);if(s.redo)s.redo();else if("add"===h)s.parent&&!W.getParent()&&s.parent.addChild(W,s.siblingsIndex),u.contains(W)||u.add(W,t.rootsIndex,t.datasIndex),this.restoreChildren(s.childrenInfo),W instanceof M.Node&&(W.setHost(s.host),s.attaches&&s.attaches.forEach(function(g){g.setHost(W)})),W instanceof M.Edge&&(W.setSource(s.source),W.setTarget(s.target));else if("remove"===h)u.remove(W);else if("clear"===h)u.clear();else if("property"===h)if("parent"===K)R?R.addChild(W,t.newIndex):(W.setParent(R),t.newIndex>=0&&u.moveTo(W,t.newIndex));else{var D=null;0===K.indexOf("a:")?(D="attr",K=K.replace("a:","")):0===K.indexOf("s:")?(D="style",K=K.replace("s:","")):0===K.indexOf("f:")&&(D="field",K=K.replace("f:","")),z.setPropertyValue(W,D,K,R)}else if("dataModelProperty"===h){var D=null;0===K.indexOf("a:")?(D="attr",K=K.replace("a:","")):0===K.indexOf("s:")?(D="style",K=K.replace("s:","")):0===K.indexOf("f:")&&(D="field",K=K.replace("f:","")),z.setPropertyValue(u,D,K,R)}else"hierarchy"===h?u.moveTo(W,s.newIndex):"index"===h&&u.moveToIndex(W,s.newIndex)}}m--}d.setIsolating(!1),delete Z._isUndoRedoing,this.afterRedo(L)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);